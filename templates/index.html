<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Mediciones</title>
  
  <style>
    /* Estilos CSS para el dashboard */
    body { margin: 0; background-color: #121212; color: #ffffff; font-family: Arial, sans-serif; }
    h1 { text-align: center; font-size: 2em; margin: 20px 0; }
    .header-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .btn { color: white; padding: 10px 20px; text-decoration: none; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
    .download-btn { background-color: #008ffb; }
    .download-btn:hover { background-color: #0073c4; }
    .delete-btn { background-color: #e94560; }
    .delete-btn:hover { background-color: #c73048; }
    .settings-btn { background-color: #777; }
    .settings-btn:hover { background-color: #555; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background-color: #2a2a2a; padding: 25px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .modal-content p { margin: 0 0 20px; font-size: 1.1em; }
    .modal-buttons .btn { margin: 0 10px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; padding: 0 40px 40px; }
    .card { background-color: #1e1e1e; border-radius: 12px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: center; }
    .chart { height: 150px; }
    canvas { margin-top: 15px; }

    /* Estilos para el formulario de alertas */
    .settings-container {
        max-width: 600px;
        margin: 0 auto 40px auto;
        padding: 20px;
        background-color: #1e1e1e;
        border-radius: 12px;
    }
    .settings-container h2 {
        margin-top: 0;
        text-align: center;
    }
    .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .form-group label {
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #555;
        background-color: #333;
        color: white;
    }
    .save-btn {
        width: 100%;
        background-color: #00e396;
    }
    .save-btn:hover {
        background-color: #00b377;
    }
    .back-btn {
        margin-top: 15px;
        background-color: #555;
    }
    .back-btn:hover {
        background-color: #444;
    }
  </style>
</head>
<body>
  
  <div id="dashboard-view">
    <h1><strong>Dashboard de Mediciones</strong></h1>
  
    <div class="header-container">
      <a href="https://dashboard-iot-488m.onrender.com/download/csv" class="btn download-btn">Descargar Datos (CSV)</a>
      <button id="delete-btn" class="btn delete-btn">Borrar Datos</button>
      <button id="go-to-settings-btn" class="btn settings-btn">Configuración de Alertas</button>
    </div>

    <div id="confirm-modal" class="modal">
      <div class="modal-content">
          <p>¿Estás seguro de que quieres borrar todos los datos? Esta acción no se puede deshacer.</p>
          <div class="modal-buttons">
              <button id="cancel-delete" class="btn">Cancelar</button>
              <button id="confirm-delete" class="btn delete-btn">Sí, Borrar Todo</button>
          </div>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div id="gaugeVolt" class="chart"></div><canvas id="chartVolt"></canvas></div>
      <div class="card"><div id="gaugeAmp" class="chart"></div><canvas id="chartAmp"></canvas></div>
      <div class="card"><div id="gaugeTemp" class="chart"></div><canvas id="chartTemp"></canvas></div>
      <div class="card"><div id="gaugeTemp1" class="chart"></div><canvas id="chartTemp1"></canvas></div>
    </div>
  </div>

  <div id="settings-view" style="display: none;">
    <div class="settings-container">
      <h2>Configuración de Alertas</h2>
      <div class="form-group">
          <label for="volt_max">Umbral Máximo de Voltaje (V):</label>
          <input type="number" id="volt_max" name="volt_max" step="0.1">
      </div>
      <div class="form-group">
          <label for="amp_max">Umbral Máximo de Corriente (A):</label>
          <input type="number" id="amp_max" name="amp_max" step="0.01">
      </div>
      <button id="save-settings-btn" class="btn save-btn">Guardar Ajustes</button>
      <button id="back-to-dashboard-btn" class="btn back-btn">Volver al Dashboard</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
    
      const MAX_DATA_POINTS = 360;
      const backendUrl = 'https://dashboard-iot-488m.onrender.com';
      
      const dashboardView = document.getElementById('dashboard-view');
      const settingsView = document.getElementById('settings-view');
      const goToSettingsBtn = document.getElementById('go-to-settings-btn');
      const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

      goToSettingsBtn.addEventListener('click', () => {
        dashboardView.style.display = 'none';
        settingsView.style.display = 'block';
      });

      backToDashboardBtn.addEventListener('click', () => {
        settingsView.style.display = 'none';
        dashboardView.style.display = 'block';
      });

      const voltMaxInput = document.getElementById('volt_max');
      const ampMaxInput = document.getElementById('amp_max');
      const saveSettingsBtn = document.getElementById('save-settings-btn');

      function cargarAjustes() {
          fetch(`${backendUrl}/api/ajustes`)
              .then(res => res.json())
              .then(data => {
                  voltMaxInput.value = data.volt_max;
                  ampMaxInput.value = data.amp_max;
              })
              .catch(err => console.error('Error al cargar ajustes:', err));
      }

      saveSettingsBtn.addEventListener('click', () => {
          const nuevosAjustes = {
              volt_max: voltMaxInput.value,
              amp_max: ampMaxInput.value
          };
          fetch(`${backendUrl}/api/ajustes`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(nuevosAjustes)
          })
          .then(res => res.json())
          .then(data => {
              alert(data.message);
          })
          .catch(err => console.error('Error al guardar ajustes:', err));
      });

      cargarAjustes();
      
      const gaugeVolt = new ApexCharts(document.querySelector("#gaugeVolt"), { chart: { type: 'radialBar' }, series: [0], labels: ['Voltaje (V)'], colors: ['#008ffb'], plotOptions: { radialBar: { hollow: { size: '60%' }, dataLabels: { value: { fontSize: '22px', formatter: (val) => val.toFixed(2) + ' V' } } } } });
      gaugeVolt.render();
      const gaugeAmp = new ApexCharts(document.querySelector("#gaugeAmp"), { chart: { type: 'radialBar' }, series: [0], labels: ['Corriente (A)'], colors: ['#feb019'], plotOptions: { radialBar: { hollow: { size: '60%' }, dataLabels: { value: { fontSize: '22px', formatter: (val) => val.toFixed(2) + ' A' } } } } });
      gaugeAmp.render();
      const gaugeTemp = new ApexCharts(document.querySelector("#gaugeTemp"), { chart: { type: 'radialBar' }, series: [0], labels: ['Temperatura Circulator (°C)'], colors: ['#00e396'], plotOptions: { radialBar: { hollow: { size: '60%' }, dataLabels: { value: { fontSize: '22px', formatter: (val) => val.toFixed(2) + ' °C' } } } } });
      gaugeTemp.render();
      const gaugeTemp1 = new ApexCharts(document.querySelector("#gaugeTemp1"), { chart: { type: 'radialBar' }, series: [0], labels: ['Temperatura DS18B20 (°C)'], colors: ['#ff4560'], plotOptions: { radialBar: { hollow: { size: '60%' }, dataLabels: { value: { fontSize: '22px', formatter: (val) => val.toFixed(2) + ' °C' } } } } });
      gaugeTemp1.render();

      function createLineChart(id, label, color) {
        const ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: label, data: [], borderColor: color,
              pointRadius: 0.3, tension: 0.1, borderWidth: 2, fill: false
            }]
          },
          options: {
            scales: {
              x: {
                type: 'time',
                display: true,
                time: {
                  unit: 'second',
                  tooltipFormat: 'HH:mm:ss',
                  displayFormats: {
                    second: 'HH:mm:ss'
                  }
                },
                ticks: { color: '#ccc' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }, 
              y: { 
                beginAtZero: false, 
                ticks: { color: '#ccc' },
                grid: { display: false }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
      const chartVolt = createLineChart('chartVolt', 'Voltaje (V)', '#008ffb');
      const chartAmp = createLineChart('chartAmp', 'Corriente (A)', '#feb019');
      const chartTemp = createLineChart('chartTemp', 'Temperatura Circulator (°C)', '#00e396');
      const chartTemp1 = createLineChart('chartTemp1', 'Temperatura DS18B20 (°C)', '#ff4560');
    
      const updateChart = (chart, newDataPoint) => {
        const data = chart.data.datasets[0].data;
        data.push(newDataPoint);
        if (data.length > MAX_DATA_POINTS) {
          data.shift();
        }
        chart.update('quiet');
      };
      
      // *** NUEVA FUNCIÓN PARA ACTUALIZAR MEDIDORES CON ESTADO DE ERROR ***
      function updateGauge(gauge, value, unit) {
        if (value < 0) {
          gauge.updateOptions({
            series: [0],
            plotOptions: {
              radialBar: {
                dataLabels: {
                  value: {
                    formatter: () => "Sensor no conectado",
                    fontSize: '16px',
                    color: "#e94560"
                  }
                }
              }
            }
          });
        } else {
          gauge.updateOptions({
            series: [value],
            plotOptions: {
              radialBar: {
                dataLabels: {
                  value: {
                    formatter: (val) => val.toFixed(2) + ` ${unit}`,
                    fontSize: '22px',
                    color: "#ffffff"
                  }
                }
              }
            }
          });
        }
      }

      // *** FUNCIÓN `actualizarUI` MODIFICADA PARA MANEJAR ERRORES ***
      function actualizarUI(lectura) {
        const timestamp = new Date(lectura.timestamp).getTime();

        updateGauge(gaugeVolt, lectura.volt, 'V');
        updateGauge(gaugeAmp, lectura.amp, 'A');
        updateGauge(gaugeTemp, lectura.temp, '°C');
        updateGauge(gaugeTemp1, lectura.temp1, '°C');

        updateChart(chartVolt, { x: timestamp, y: lectura.volt < 0 ? null : lectura.volt });
        updateChart(chartAmp, { x: timestamp, y: lectura.amp < 0 ? null : lectura.amp });
        updateChart(chartTemp, { x: timestamp, y: lectura.temp < 0 ? null : lectura.temp });
        updateChart(chartTemp1, { x: timestamp, y: lectura.temp1 < 0 ? null : lectura.temp1 });
      }
    
      const deleteBtn = document.getElementById('delete-btn');
      const modal = document.getElementById('confirm-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      deleteBtn.addEventListener('click', () => { modal.style.display = 'flex'; });
      cancelDeleteBtn.addEventListener('click', () => { modal.style.display = 'none'; });
      confirmDeleteBtn.addEventListener('click', () => {
        fetch(`${backendUrl}/api/delete-all`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            console.log(data.message);
            modal.style.display = 'none';
            window.location.reload();
          })
          .catch(error => {
            console.error('Error al intentar borrar los datos:', error);
            modal.style.display = 'none';
          });
      });
    
      let ultimoIdProcesado = -1;

      function cargarDatosIniciales() {
        fetch(`${backendUrl}/api/initial-data`)
          .then(res => res.json())
          .then(datos => {
            console.log(`Cargados ${datos.length} registros históricos.`);
            
            const fillChart = (chart, data, key) => {
                chart.data.datasets[0].data = data.map(d => ({ x: new Date(d.timestamp).getTime(), y: d[key] < 0 ? null : d[key] }));
                chart.update();
            };

            fillChart(chartVolt, datos, 'volt');
            fillChart(chartAmp, datos, 'amp');
            fillChart(chartTemp, datos, 'temp');
            fillChart(chartTemp1, datos, 'temp1');
            
            if (datos.length > 0) {
                ultimoIdProcesado = datos[datos.length - 1].id;
            }
          })
          .catch(err => console.error('Error al cargar datos iniciales:', err));
      }

      function cargarUltimaLectura() {
        fetch(`${backendUrl}/api/ultima-lectura`)
          .then(res => res.json())
          .then(lectura => {
            if (lectura && lectura.id && lectura.id !== ultimoIdProcesado) {
              actualizarUI(lectura);
              ultimoIdProcesado = lectura.id;
            }
          })
          .catch(err => console.error('Error al cargar última lectura:', err));
      }

      cargarDatosIniciales();
      setInterval(cargarUltimaLectura, 500);
    
    });
  </script>
</body>
</html>
